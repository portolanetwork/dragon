/*
 * Copyright 2025 Sami Malik
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Author: Sami Malik (sami.malik [at] portolanetwork.io)
 */

package app.dragon.turnstile.db

import app.dragon.turnstile.db.TurnstilePostgresProfile.api.*
import app.dragon.turnstile.monitoring.EventData
import io.circe.Json
import io.circe.syntax.*

import java.sql.Timestamp
import java.util.UUID

/**
 * Slick table definitions for MCP server persistence and event logging.
 *
 * Database Schema:
 * - mcp_server: Stores user-registered MCP servers
 *   - id: Auto-incrementing primary key
 *   - uuid: Server UUID (globally unique across entire table)
 *   - tenant: Tenant identifier for multi-tenancy
 *   - user_id: User identifier
 *   - name: Server name (unique per tenant+user combination)
 *   - url: Server URL
 *   - client_id: OAuth client ID (optional)
 *   - client_secret: OAuth client secret (optional)
 *   - refresh_token: OAuth refresh token (optional)
 *   - token_endpoint: OAuth token endpoint URL (optional)
 *   - auth_type: Authentication type (none, discover, or static_auth_header)
 *   - static_token: Static authentication token (optional)
 *   - transport_type: Transport type (streaming_http)
 *   - created_at: Timestamp of creation
 *   - updated_at: Timestamp of last update
 *
 * - event_log: Stores audit events and system logs
 *   - id: Auto-incrementing primary key
 *   - uuid: Event UUID (globally unique)
 *   - tenant: Tenant identifier
 *   - user_id: User identifier (nullable for system events)
 *   - event_type: Event type (e.g., TOOL_EXECUTED, MCP_REQUEST_PROCESSED)
 *   - description: Human-readable event description
 *   - metadata: JSONB field for event-specific structured data
 *   - created_at: Timestamp when event occurred
 *
 * Indexes:
 * - idx_mcp_servers_tenant: Fast lookup by tenant
 * - idx_mcp_servers_tenant_user: Lookup by tenant and user
 * - idx_mcp_servers_uuid: Unique constraint on uuid
 * - idx_mcp_servers_tenant_user_name: Unique constraint on (tenant, user_id, name)
 * - idx_event_log_tenant: Fast lookup by tenant
 * - idx_event_log_tenant_user: Lookup by tenant and user
 * - idx_event_log_event_type: Lookup by event type
 * - idx_event_log_created_at: Time-based queries
 * - idx_event_log_metadata: GIN index for JSONB searches
 */

/**
 * MCP server table row representation
 *
 * @param id Auto-incrementing primary key
 * @param uuid Server UUID (globally unique across entire table)
 * @param tenant Tenant identifier
 * @param userId User identifier
 * @param name Server name (unique per tenant+user combination)
 * @param url Server URL
 * @param clientId OAuth client ID (optional)
 * @param clientSecret OAuth client secret (optional)
 * @param refreshToken OAuth refresh token (optional)
 * @param tokenEndpoint OAuth token endpoint URL (optional)
 * @param authType Authentication type: none, discover, or static_auth_header
 * @param staticToken Static authentication token (optional)
 * @param transportType Transport type: streaming_http
 * @param createdAt Creation timestamp
 * @param updatedAt Last update timestamp
 */
case class McpServerRow(
  id: Long = 0L,
  uuid: UUID = UUID.randomUUID(), // Placeholder value; actual UUID generated by database
  tenant: String,
  userId: String,
  name: String,
  url: String,
  clientId: Option[String] = None,
  clientSecret: Option[String] = None,
  refreshToken: Option[String] = None,
  tokenEndpoint: Option[String] = None,
  authType: String = "none",
  staticToken: Option[String] = None,
  transportType: String = "streaming_http",
  createdAt: Timestamp = new Timestamp(System.currentTimeMillis()),
  updatedAt: Timestamp = new Timestamp(System.currentTimeMillis())
)

/**
 * Slick table definition for mcp_server
 */
class McpServersTable(
  tag: Tag
) extends Table[McpServerRow](tag, "mcp_server") {
  def id = column[Long]("id", O.PrimaryKey, O.AutoInc)
  def uuid = column[UUID]("uuid", O.Default(java.util.UUID.randomUUID()))
  def tenant = column[String]("tenant")
  def userId = column[String]("user_id")
  def name = column[String]("name")
  def url = column[String]("url")
  def clientId = column[Option[String]]("client_id")
  def clientSecret = column[Option[String]]("client_secret")
  def refreshToken = column[Option[String]]("refresh_token")
  def tokenEndpoint = column[Option[String]]("token_endpoint")
  def authType = column[String]("auth_type", O.Default("none"))
  def staticToken = column[Option[String]]("static_token")
  def transportType = column[String]("transport_type", O.Default("streaming_http"))
  def createdAt = column[Timestamp]("created_at")
  def updatedAt = column[Timestamp]("updated_at")

  // Index on tenant for fast lookup
  def idxTenant = index("idx_mcp_servers_tenant", tenant)

  // Index on (tenant, user_id)
  def idxTenantUser = index("idx_mcp_servers_tenant_user", (tenant, userId))

  // Unique index on uuid (globally unique)
  def idxUuid = index("idx_mcp_servers_uuid", uuid, unique = true)

  // Unique index on (tenant, user_id, name)
  def idxTenantUserName = index("idx_mcp_servers_tenant_user_name", (tenant, userId, name), unique = true)

  def * = (id, uuid, tenant, userId, name, url, clientId, clientSecret, refreshToken, tokenEndpoint, authType, staticToken, transportType, createdAt, updatedAt).mapTo[McpServerRow]
}

/**
 * Event log table row representation
 *
 * @param id Auto-incrementing primary key
 * @param uuid Event UUID (globally unique)
 * @param tenant Tenant identifier
 * @param userId User identifier (nullable for system events)
 * @param eventType Event type (e.g., TOOL_EXECUTED, MCP_REQUEST_PROCESSED, etc.)
 * @param description Human-readable event description
 * @param metadata Extensible JSONB field for event-specific structured data (stored as Circe Json)
 * @param createdAt Creation timestamp
 */
case class EventLogRow(
  id: Long = 0L,
  uuid: UUID = UUID.randomUUID(), // Placeholder value; actual UUID generated by database
  tenant: String,
  userId: Option[String] = None,
  eventType: String,
  description: Option[String] = None,
  metadata: Json = Json.obj(),
  createdAt: Timestamp = new Timestamp(System.currentTimeMillis())
)

/**
 * Slick table definition for event_log
 *
 * Uses slick-pg Circe JSONB support from TurnstilePostgresProfile.
 */
class EventLogTable(
  tag: Tag
) extends Table[EventLogRow](tag, "event_log") {
  // Explicitly import JSONB type mapper for Circe Json
  import app.dragon.turnstile.db.TurnstilePostgresProfile.TurnstileAPI.circeJsonTypeMapper

  def id = column[Long]("id", O.PrimaryKey, O.AutoInc)
  def uuid = column[UUID]("uuid", O.Default(java.util.UUID.randomUUID()))
  def tenant = column[String]("tenant")
  def userId = column[Option[String]]("user_id")
  def eventType = column[String]("event_type")
  def description = column[Option[String]]("description")
  def metadata = column[Json]("metadata")
  def createdAt = column[Timestamp]("created_at")

  // Index on tenant for fast lookup
  def idxTenant = index("idx_event_log_tenant", tenant)

  // Index on (tenant, user_id)
  def idxTenantUser = index("idx_event_log_tenant_user", (tenant, userId))

  // Index on event_type
  def idxEventType = index("idx_event_log_event_type", eventType)

  // Index on created_at
  def idxCreatedAt = index("idx_event_log_created_at", createdAt)

  // Unique index on uuid (globally unique)
  def idxUuid = index("idx_event_log_uuid", uuid, unique = true)

  def * = (id, uuid, tenant, userId, eventType, description, metadata, createdAt).mapTo[EventLogRow]
}

/**
 * Table queries object for accessing tables
 */
object Tables {
  /**
   * MCP servers table query
   */
  val mcpServers = TableQuery[McpServersTable]

  /**
   * Event log table query
   */
  val eventLogs = TableQuery[EventLogTable]
}
