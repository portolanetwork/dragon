syntax = "proto3";

package dragon.turnstile.v1;

option java_multiple_files = true;
option java_package = "dragon.turnstile.api.v1";
option java_outer_classname = "TurnstileProto";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
//import "dragon/common/v1/objects.proto";


option go_package = "dragon/turnstile/api/v1";

// Authentication types for MCP servers
enum AuthType {
    AUTH_TYPE_UNSPECIFIED = 0;
    AUTH_TYPE_NONE = 1;          // No authentication required
    AUTH_TYPE_DISCOVER = 2;       // Use OAuth discovery
    AUTH_TYPE_STATIC_HEADER = 3;  // Static authentication header
}

// Login status for OAuth-enabled MCP servers
enum LoginStatus {
    LOGIN_STATUS_UNSPECIFIED = 0;
    LOGIN_STATUS_NOT_AUTHENTICATED = 1;   // User has not authenticated yet
    LOGIN_STATUS_AUTHENTICATED = 2;       // User is authenticated with valid tokens
    LOGIN_STATUS_EXPIRED = 3;             // Authentication has expired
    LOGIN_STATUS_NOT_APPLICABLE = 4;      // Server does not require OAuth (AUTH_TYPE_NONE or AUTH_TYPE_STATIC_HEADER)
}

enum TransportType {
    TRANSPORT_TYPE_UNSPECIFIED = 0;
    TRANSPORT_TYPE_STREAMING_HTTP = 1;
}

service TurnstileService {
    rpc ListMcpServers (ListMcpServersRequest)  returns (McpServerList) {}
    rpc AddMcpServer (AddMcpServerRequest) returns (McpServer) {}
    rpc RemoveMcpServer (RemoveMcpServerRequest) returns (google.protobuf.Empty) {}

    rpc GetLoginStatusForMcpServer (GetLoginStatusForMcpServerRequest) returns (McpServerLoginStatus) {}
    rpc LoginMcpServer (LoginMcpServerRequest) returns (McpServerLoginUrl) {}
    rpc LogoutMcpServer (LogoutMcpServerRequest) returns (google.protobuf.Empty) {}

    rpc LoadToolsForMcpServer (LoadToolsForMcpServerRequest) returns (google.protobuf.Empty) {}
    rpc UnloadToolsForMcpServer (UnloadToolsForMcpServerRequest) returns (google.protobuf.Empty) {}

    rpc GetEventLog (GetEventLogRequest) returns (EventLogList) {}
}

// MCP Servers
message AddMcpServerRequest {
    string name = 10;
    string url = 20;
    AuthType auth_type = 30; // Authentication type
    string static_token = 40; // Static authentication token (optional, used with AUTH_TYPE_STATIC_HEADER)
}

message ListMcpServersRequest {
    string user_id = 10;
    //string cursor = 20;
    //int32 page_size = 30;
}

message RemoveMcpServerRequest {
    string uuid = 10;
}

message McpServerList {
    repeated McpServer mcp_server = 10;
    //string next_cursor = 20;
}

// OAuth configuration details (non-sensitive fields only)
message OAuthConfig {
    string client_id = 10;           // OAuth client ID (safe to expose)
    string token_endpoint = 20;      // OAuth token endpoint URL
    bool has_client_secret = 30;     // Indicates if client secret is configured
    bool has_refresh_token = 40;     // Indicates if refresh token is stored
}

message McpServer {
    string uuid = 10;
    string name = 20;
    string url = 30;
    AuthType auth_type = 40;                  // Authentication type
    TransportType transport_type = 50;        // Transport type
    bool has_static_token = 60;               // Indicates if a static token is configured (token value not returned for security)
    OAuthConfig oauth_config = 70;            // OAuth configuration (only present for AUTH_TYPE_DISCOVER)
    google.protobuf.Timestamp created_at = 80; // Creation timestamp
    google.protobuf.Timestamp updated_at = 90; // Last update timestamp
}



message GetLoginStatusForMcpServerRequest {
    string uuid = 10;  // UUID of the MCP server to check login status for
}

message McpServerLoginStatus {
    string uuid = 10;                              // UUID of the MCP server
    LoginStatus status = 20;                       // Current login status
    AuthType auth_type = 30;                       // Authentication type of the server
}

message LoginMcpServerRequest {
    string uuid = 10;
}

message McpServerLoginUrl {
    string login_url = 10;
}

message LogoutMcpServerRequest {
    string uuid = 10;
}

message LoadToolsForMcpServerRequest {
    string uuid = 10;
}

message UnloadToolsForMcpServerRequest {
    string uuid = 10;
}

// Filter for event log queries
message Filter {
   string event_type = 30;
}

// Request to get event logs with filtering and pagination
message GetEventLogRequest {
   Filter filter = 10;
   string cursor = 20;      // Cursor for pagination (timestamp-based)
   int32 page_size = 30;    // Number of events per page (default: 100, max: 1000)
}

// Response containing list of event logs
message EventLogList {
  repeated EventLog event_log = 10;
  string next_cursor = 20;  // Cursor for next page
}

// Individual event log entry
message EventLog {
   int64 id = 10;                            // Database primary key
   string uuid = 20;                         // Globally unique event identifier
   string tenant = 30;                       // Tenant identifier
   string user_id = 40;                      // User who performed the action (optional for system events)
   string event_type = 50;                   // Event type (e.g., TOOL_EXECUTED, MCP_REQUEST_PROCESSED)
   string description = 60;                  // Human-readable event description
   google.protobuf.Struct metadata = 70;     // Event-specific structured data (JSONB)
   google.protobuf.Timestamp created_at = 80; // Event creation timestamp
}
