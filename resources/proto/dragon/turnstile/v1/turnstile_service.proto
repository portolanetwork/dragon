syntax = "proto3";

package dragon.turnstile.v1;

option java_multiple_files = true;
option java_package = "dragon.turnstile.api.v1";
option java_outer_classname = "TurnstileProto";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
//import "dragon/common/v1/objects.proto";


option go_package = "dragon/turnstile/api/v1";

// Authentication types for MCP servers
enum AuthType {
    AUTH_TYPE_UNSPECIFIED = 0;
    AUTH_TYPE_NONE = 1;          // No authentication required
    AUTH_TYPE_DISCOVER = 2;       // Use OAuth discovery
    AUTH_TYPE_STATIC_HEADER = 3;  // Static authentication header
}

// Login status for OAuth-enabled MCP servers
enum LoginStatus {
    LOGIN_STATUS_UNSPECIFIED = 0;
    LOGIN_STATUS_NOT_AUTHENTICATED = 1;  // User has not authenticated yet
    LOGIN_STATUS_AUTHENTICATED = 2;       // User is authenticated with valid tokens
    LOGIN_STATUS_EXPIRED = 3;             // Authentication has expired
    LOGIN_STATUS_NOT_APPLICABLE = 4;      // Server does not require OAuth (AUTH_TYPE_NONE or AUTH_TYPE_STATIC_HEADER)
}

service TurnstileService {
    rpc ListMcpServers (ListMcpServersRequest)  returns (McpServerList) {}
    rpc CreateMcpServer (CreateMcpServerRequest) returns (McpServer) {}
    rpc DeleteMcpServer (DeleteMcpServerRequest) returns (google.protobuf.Empty) {}

    rpc GetLoginStatusForMcpServer (GetLoginStatusForMcpServerRequest) returns (McpServerLoginStatus) {}
    rpc LoginToMcpServer (LoginMcpServerRequest) returns (McpServerLoginUrl) {}
    
}

// MCP Servers
message CreateMcpServerRequest {
    string name = 1;
    string url = 2;
    AuthType auth_type = 3; // Authentication type
    string static_token = 4; // Static authentication token (optional, used with AUTH_TYPE_STATIC_HEADER)
}

message ListMcpServersRequest {
    string user_id = 1;
    //string page_size = 2;
    //string page_token = 3;
}

message DeleteMcpServerRequest {
    string uuid = 1;
}

message McpServerList {
    repeated McpServer mcp_server = 1;
}

// OAuth configuration details (non-sensitive fields only)
message OAuthConfig {
    string client_id = 1;           // OAuth client ID (safe to expose)
    string token_endpoint = 2;      // OAuth token endpoint URL
    bool has_client_secret = 3;     // Indicates if client secret is configured
    bool has_refresh_token = 4;     // Indicates if refresh token is stored
}

message McpServer {
    string uuid = 1;
    string name = 2;
    string url = 3;
    AuthType auth_type = 4;                  // Authentication type
    bool has_static_token = 5;               // Indicates if a static token is configured (token value not returned for security)
    OAuthConfig oauth_config = 6;            // OAuth configuration (only present for AUTH_TYPE_DISCOVER)
    google.protobuf.Timestamp created_at = 7; // Creation timestamp
    google.protobuf.Timestamp updated_at = 8; // Last update timestamp
}



message GetLoginStatusForMcpServerRequest {
    string uuid = 1;  // UUID of the MCP server to check login status for
}

message McpServerLoginStatus {
    string uuid = 1;                              // UUID of the MCP server
    LoginStatus status = 2;                       // Current login status
    AuthType auth_type = 3;                       // Authentication type of the server
    bool has_refresh_token = 4;                   // Indicates if a refresh token is stored
    google.protobuf.Timestamp token_expires_at = 5; // When the current access token expires (if applicable)
}

message LoginMcpServerRequest {
    string uuid = 1;
}

message McpServerLoginUrl {
    string login_url = 1;
}
